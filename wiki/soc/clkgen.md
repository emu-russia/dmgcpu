# Clock Generator & System Control

![locator_clkgen](/imgstore/soc/locator_clkgen.jpg)

![clkgen](/imgstore/soc/clkgen.jpg)

![clkgen_netlist](/imgstore/soc/clkgen_netlist.png)

The names of signals of the CLK group have many synonyms used by different authors at different times.

|Signal|Dir|From/Where To|Description|
|---|---|---|---|
|clk_ena|input|From Core| |
|osc_ena|input|From Core| |
|cpu_wr_sync|output|To MMIO,Arb| |
|cpu_wr|input|From Core| |
|ext_cs_en|output|To Arb| |
|test_1|input|From MMIO| (Aka T1nT2)|
|cpu_mreq|input|From Core| |
|sync_reset|output|To Core| |
|reset|input|From /RESET Pad| |
|osc_stable|input|From MMIO| |
|n_test_reset|input|From MMIO| |
|n_clk_in|input|From CK1_CK2 Pad| |
|n_reset2|output|To Ser,MMIO,Arb,PPU,APU|Global reset signal |
|clk1|output|To Core| (Aka BOWA,ADR_CLK_N)|
|clk2|output|To Core,MMIO,Arb,APU| (Aka DATA_VALID,ADR_CLK_P)|
|clk3|output|To Core | (Aka CPU_PHI,DATA_CLK_P)|
|clk4|output|To Core,MMIO,APU,PHI Pad| (Aka #CPU_PHI,DATA_CLK_N)|
|clk5|output|To Core| (Aka INC_CLK_N)|
|clk6|output|To Core,MMIO,PPU,APU| (Aka INC_CLK_P)|
|clk7|output|To Core,HRAM,APU| (Aka BUKE,LATCH_CLK)|
|clk8|output|To Core| (Aka BOMA_1MHZ,MAIN_CLK_N)|
|clk9|output|To Core,MMIO,APU| (Aka BOGA_1MHZ,MAIN_CLK_P)|
|cclk|output|To APU,PPU| (Aka AZOF)|

## DeepSeek Analysis

### Detailed Description of the DMG-CPU ClkGen & System Control Verilog Module

The `ClkGen` module is a **clock generation and system control unit** for the DMG-CPU (Game Boy CPU). It generates multiple clock signals, manages system resets, and controls external chip select and write synchronization. Below is a detailed breakdown of its functionality and structure.

---

### **Module Overview**
The `ClkGen` module is responsible for:
1. **Clock Generation**: Produces multiple clock signals (`clk1` to `clk9`, `cclk`) for different parts of the CPU and peripherals.
2. **Reset Management**: Handles system resets (`reset`, `n_reset2`, `sync_reset`) and ensures proper initialization.
3. **External Chip Select Control**: Manages the external chip select signal (`ext_cs_en`) for memory and peripheral access.
4. **Write Synchronization**: Synchronizes CPU write operations (`cpu_wr_sync`) with the clock.
5. **Oscillator Control**: Manages the oscillator enable (`osc_ena`) and stability (`osc_stable`) signals.

---

### **Inputs and Outputs**

#### **Inputs**
1. **`clk_ena`**: Clock enable signal.
2. **`osc_ena`**: Oscillator enable signal.
3. **`cpu_wr`**: CPU write signal.
4. **`test_1`**: Test signal (used for debugging or testing).
5. **`cpu_mreq`**: CPU memory request signal.
6. **`reset`**: System reset signal.
7. **`osc_stable`**: Oscillator stability signal.
8. **`n_test_reset`**: Active-low test reset signal.
9. **`n_clk_in`**: Active-low external clock input.

#### **Outputs**
1. **`clk1` to `clk9`**: Generated clock signals for various CPU and peripheral components.
2. **`cclk`**: Core clock signal.
3. **`n_reset2`**: Active-low reset signal for the system.
4. **`sync_reset`**: Synchronized reset signal.
5. **`ext_cs_en`**: External chip select enable signal.
6. **`cpu_wr_sync`**: Synchronized CPU write signal.

### **Signal Flow**
1. **Clock Generation**:
   - The external clock input (`n_clk_in`) is inverted and divided to generate multiple clock signals (`clk1` to `clk9`, `cclk`).
   - The clocks are synchronized with the oscillator enable (`osc_ena`) and stability (`osc_stable`) signals.

2. **Reset Management**:
   - The system reset signal (`reset`) is synchronized with the clock to generate `n_reset2` and `sync_reset`.
   - Flip-flops (`dmg_dffrnq_comp`) are used to debounce and synchronize the reset signals.

3. **External Chip Select Control**:
   - The `ext_cs_en` signal is generated based on the `cpu_mreq` signal and internal logic.
   - It enables external memory or peripheral access when the CPU requests it.

4. **Write Synchronization**:
   - The `cpu_wr_sync` signal is generated by synchronizing the `cpu_wr` signal with the clock.
   - It ensures that write operations are properly aligned with the clock cycles.

5. **Oscillator Control**:
   - The oscillator enable (`osc_ena`) and stability (`osc_stable`) signals are managed to ensure proper clock generation.
   - These signals ensure that the oscillator is stable before enabling clock generation.

## Map

|Row|Cells|
|---|---|
|1|not, not, not2(unused), not3, nand, nor, not2(unused), not3, nor, oan, not, not2, or, dffrnq_comp, nor_latch, nor, not, not, dffrnq_comp, not, dffrnq_comp, not, dffrnq_comp, not, dffrnq_comp, not, not2, nand, nand, not, not6 |
|2|not6, not6, or, not, not, nand3, not, not2(unused), not2(unused), not2(unused), not2(unused), not2(unused), not, not, nand4, not6, not, not, nor3, not4+not6, not4+not6, not2, nor3, not4+not6, not4+not6, not2, nor, not6, not6, and, not, not |
